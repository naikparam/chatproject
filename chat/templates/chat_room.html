{% extends 'base.html' %}

{% block title %}Chat with {{ other_user.username }} - Django Chat{% endblock %}

{% block extra_css %}
<style>
    .chat-messages {
        height: 500px;
        overflow-y: auto;
        background: linear-gradient(to bottom, #f8f9fa, #ffffff);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        scroll-behavior: smooth;
        position: relative;
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.05);
        border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
    }

    .message {
        margin-bottom: 15px;
        animation: fadeInUp 0.3s ease;
        position: relative;
    }

    .message-sent {
        display: flex;
        justify-content: flex-end;
    }

    .message-received {
        display: flex;
        justify-content: flex-start;
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 20px;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .message-bubble-sent {
        background: var(--sent-message-bg);
        color: white;
        border-bottom-right-radius: 5px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .message-bubble-received {
        background: var(--received-message-bg);
        color: #333;
        border-bottom-left-radius: 5px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 5px;
        display: block;
    }

    .message-status {
        font-size: 0.7rem;
        opacity: 0.6;
        margin-top: 2px;
    }

    .message-input-area {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 25px;
        padding: 15px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .form-control-custom {
        border: 2px solid transparent;
        border-radius: 25px;
        padding: 12px 20px;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .form-control-custom:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        background: white;
    }

    .typing-indicator {
        display: none;
        align-items: center;
        margin: 10px 0;
        color: #6c757d;
        font-style: italic;
        padding: 10px;
        background: rgba(108, 117, 125, 0.1);
        border-radius: 15px;
        animation: fadeInUp 0.3s ease;
    }

    .typing-dots {
        display: inline-flex;
        margin-left: 8px;
    }

    .typing-dots span {
        height: 8px;
        width: 8px;
        background: #6c757d;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: typing 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% { 
            transform: translateY(0); 
            opacity: 0.5; 
        }
        30% { 
            transform: translateY(-15px); 
            opacity: 1; 
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-header {
        background: var(--bg-gradient);
        color: white;
        padding: 20px;
        border-radius: 20px 20px 0 0;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .back-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        border-radius: 50px;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateX(-5px);
        color: white;
    }

    .user-avatar-large {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.5rem;
        margin-right: 15px;
    }

    .send-btn {
        background: var(--bg-gradient);
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .send-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .send-btn:disabled {
        background: #6c757d;
        transform: none;
        box-shadow: none;
    }

    .connection-status {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .connected {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }

    .disconnected {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }

    .message-group {
        margin-bottom: 20px;
    }

    .message-group-date {
        text-align: center;
        margin: 20px 0;
        position: relative;
    }

    .message-group-date::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: rgba(0,0,0,0.1);
        z-index: 1;
    }

    .message-group-date span {
        background: white;
        padding: 5px 15px;
        color: #6c757d;
        font-size: 0.8rem;
        border-radius: 15px;
        position: relative;
        z-index: 2;
    }

    .emoji-picker {
        position: absolute;
        bottom: 70px;
        right: 20px;
        background: white;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        display: none;
        z-index: 1000;
    }

    .emoji-picker.show {
        display: block;
        animation: fadeInUp 0.2s ease;
    }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 5px;
        max-width: 240px;
    }

    .emoji-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        padding: 5px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .emoji-btn:hover {
        background: rgba(102, 126, 234, 0.1);
    }

    .attachment-btn {
        background: rgba(108, 117, 125, 0.1);
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        transition: all 0.3s ease;
        margin-right: 8px;
    }

    .attachment-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: var(--primary-color);
        transform: scale(1.1);
    }

    .message-reactions {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }

    .reaction {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 15px;
        padding: 2px 8px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .reaction:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-xl-6">
        <div class="chat-container position-relative">
            <!-- Connection Status -->
            <div class="connection-status disconnected" id="connectionStatus">
                <i class="fas fa-wifi me-1"></i>Connecting...
            </div>

            <!-- Chat Header -->
            <div class="chat-header">
                <div class="d-flex align-items-center">
                    <a href="{% url 'chat_list' %}" class="back-btn me-3">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div class="user-avatar-large">
                        {{ other_user.username|first|upper }}
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="mb-0">{{ other_user.username }}</h5>
                        <div class="user-status-text" data-user-id="{{ other_user.id }}">
                            <small class="opacity-75">
                                <span class="offline-indicator me-1"></span>
                                <span class="status-text">Offline</span>
                            </small>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-link text-white" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="clearChat"><i class="fas fa-trash me-2"></i>Clear Chat</a></li>
                            <li><a class="dropdown-item" href="#" id="blockUser"><i class="fas fa-ban me-2"></i>Block User</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                {% regroup messages by timestamp|date:"Y-m-d" as messages_by_date %}
                {% for date_group in messages_by_date %}
                    <div class="message-group-date">
                        <span>{{ date_group.grouper|date:"F d, Y" }}</span>
                    </div>
                    {% for message in date_group.list %}
                    <div class="message {% if message.sender == user %}message-sent{% else %}message-received{% endif %}" data-message-id="{{ message.id }}">
                        <div class="message-bubble {% if message.sender == user %}message-bubble-sent{% else %}message-bubble-received{% endif %}">
                            {{ message.content }}
                            <div class="message-time">
                                {{ message.timestamp|date:"g:i A" }}
                                {% if message.sender == user %}
                                <span class="message-status">
                                    {% if message.is_read %}
                                        <i class="fas fa-check-double text-info"></i>
                                    {% else %}
                                        <i class="fas fa-check"></i>
                                    {% endif %}
                                </span>
                                {% endif %}
                            </div>
                            <!-- Message reactions (placeholder) -->
                            <div class="message-reactions" style="display: none;">
                                <span class="reaction">üòä 2</span>
                                <span class="reaction">üëç 1</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% empty %}
                    <div class="text-center py-5">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No messages yet</h6>
                        <p class="text-muted">Start the conversation by sending a message!</p>
                    </div>
                {% endfor %}
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-2" style="width: 30px; height: 30px; font-size: 0.8rem;">
                            {{ other_user.username|first|upper }}
                        </div>
                        <div>
                            {{ other_user.username }} is typing
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emoji Picker -->
            <div class="emoji-picker" id="emojiPicker">
                <div class="emoji-grid">
                    <button class="emoji-btn" data-emoji="üòä">üòä</button>
                    <button class="emoji-btn" data-emoji="üòÇ">üòÇ</button>
                    <button class="emoji-btn" data-emoji="ü•∞">ü•∞</button>
                    <button class="emoji-btn" data-emoji="üòç">üòç</button>
                    <button class="emoji-btn" data-emoji="ü§î">ü§î</button>
                    <button class="emoji-btn" data-emoji="üòé">üòé</button>
                    <button class="emoji-btn" data-emoji="üò¢">üò¢</button>
                    <button class="emoji-btn" data-emoji="üò±">üò±</button>
                    <button class="emoji-btn" data-emoji="üëç">üëç</button>
                    <button class="emoji-btn" data-emoji="üëé">üëé</button>
                    <button class="emoji-btn" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
                    <button class="emoji-btn" data-emoji="üî•">üî•</button>
                    <button class="emoji-btn" data-emoji="üíØ">üíØ</button>
                    <button class="emoji-btn" data-emoji="üéâ">üéâ</button>
                    <button class="emoji-btn" data-emoji="‚ú®">‚ú®</button>
                    <button class="emoji-btn" data-emoji="üåü">üåü</button>
                </div>
            </div>

            <!-- Message Input Area -->
            <div class="message-input-area">
                <div class="input-group">
                    <button class="attachment-btn" type="button" title="Attach file">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="attachment-btn" type="button" id="emojiToggle" title="Add emoji">
                        <i class="fas fa-smile"></i>
                    </button>
                    <input type="text" 
                           class="form-control form-control-custom" 
                           id="messageInput" 
                           placeholder="Type your message..." 
                           autocomplete="off"
                           maxlength="500">
                    <button class="send-btn" type="button" id="sendButton" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        Press Enter to send ‚Ä¢ Shift+Enter for new line
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const userId = {{ other_user.id }};
    const currentUserId = {{ user.id }};
    const currentUsername = "{{ user.username }}";
    const otherUsername = "{{ other_user.username }}";
    
    let chatSocket;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const connectionStatus = document.getElementById('connectionStatus');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiToggle = document.getElementById('emojiToggle');

    let typingTimer;
    let isTyping = false;
    let lastTypingTime = 0;

    // Initialize WebSocket connection
    function connectWebSocket() {
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        chatSocket = new WebSocket(
            wsScheme + '://' + window.location.host + '/ws/chat/' + userId + '/'
        );

        chatSocket.onopen = function(e) {
            console.log('WebSocket connection established');
            connectionStatus.className = 'connection-status connected';
            connectionStatus.innerHTML = '<i class="fas fa-wifi me-1"></i>Connected';
            reconnectAttempts = 0;
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('Received message:', data);

            if (data.type === 'message') {
                addMessageToChat(data);
                playNotificationSound();
            } else if (data.type === 'user_status') {
                updateUserStatus(data);
            } else if (data.type === 'typing') {
                handleTypingIndicator(data);
            }
        };

        chatSocket.onclose = function(e) {
            console.log('WebSocket connection closed');
            connectionStatus.className = 'connection-status disconnected';
            connectionStatus.innerHTML = '<i class="fas fa-wifi me-1"></i>Disconnected';
            
            // Attempt to reconnect
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(() => {
                    console.log(`Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})`);
                    connectWebSocket();
                }, 2000 * reconnectAttempts);
            }
        };

        chatSocket.onerror = function(error) {
            console.error('WebSocket error:', error);
            connectionStatus.className = 'connection-status disconnected';
            connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
        };
    }

    // Initialize connection
    connectWebSocket();

    // Auto scroll to bottom
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Initial scroll
    scrollToBottom();

    // Add message to chat
    function addMessageToChat(data) {
        const messageDiv = document.createElement('div');
        const isSent = data.user_id === currentUserId;
        
        messageDiv.className = `message ${isSent ? 'message-sent' : 'message-received'}`;
        messageDiv.innerHTML = `
            <div class="message-bubble ${isSent ? 'message-bubble-sent' : 'message-bubble-received'}">
                ${escapeHtml(data.message)}
                <div class="message-time">
                    ${formatTime(new Date(data.timestamp))}
                    ${isSent ? '<span class="message-status"><i class="fas fa-check"></i></span>' : ''}
                </div>
            </div>
        `;
        
        // Remove typing indicator if it's from the other user
        if (!isSent) {
            typingIndicator.style.display = 'none';
        }
        
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // Send message
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
            sendButton.disabled = true;
            
            // Stop typing indicator
            if (isTyping) {
                chatSocket.send(JSON.stringify({
                    'type': 'stop_typing'
                }));
                isTyping = false;
            }
        }
    }

    // Handle typing
    function handleTyping() {
        const now = Date.now();
        lastTypingTime = now;
        
        if (!isTyping) {
            isTyping = true;
            chatSocket.send(JSON.stringify({
                'type': 'typing'
            }));
        }
        
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            if (Date.now() - lastTypingTime >= 1000 && isTyping) {
                chatSocket.send(JSON.stringify({
                    'type': 'stop_typing'
                }));
                isTyping = false;
            }
        }, 1000);
    }

    // Handle typing indicator
    function handleTypingIndicator(data) {
        if (data.user_id !== currentUserId) {
            if (data.is_typing) {
                typingIndicator.style.display = 'flex';
                scrollToBottom();
            } else {
                typingIndicator.style.display = 'none';
            }
        }
    }

    // Update user status
    function updateUserStatus(data) {
        const statusElements = document.querySelectorAll(`[data-user-id="${data.user_id}"]`);
        statusElements.forEach(element => {
            const indicator = element.querySelector('.offline-indicator, .online-indicator');
            const statusText = element.querySelector('.status-text');
            
            if (indicator) {
                indicator.className = data.is_online ? 'online-indicator' : 'offline-indicator';
            }
            
            if (statusText) {
                statusText.textContent = data.is_online ? 'Online' : 'Offline';
            }
        });
    }

    // Event listeners
    messageInput.addEventListener('input', function() {
        const hasText = this.value.trim().length > 0;
        sendButton.disabled = !hasText;
        
        if (hasText) {
            handleTyping();
        }
    });

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    sendButton.addEventListener('click', sendMessage);

    // Emoji picker
    emojiToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        emojiPicker.classList.toggle('show');
    });

    document.addEventListener('click', function(e) {
        if (!emojiPicker.contains(e.target) && e.target !== emojiToggle) {
            emojiPicker.classList.remove('show');
        }
    });

    emojiPicker.addEventListener('click', function(e) {
        if (e.target.classList.contains('emoji-btn')) {
            const emoji = e.target.dataset.emoji;
            messageInput.value += emoji;
            messageInput.focus();
            emojiPicker.classList.remove('show');
            sendButton.disabled = messageInput.value.trim().length === 0;
        }
    });

    // Utility functions
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function formatTime(date) {
        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function playNotificationSound() {
        // Create a subtle notification sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
    }

    // Focus input on load
    messageInput.focus();

    // Handle page visibility for typing indicators
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && isTyping) {
            chatSocket.send(JSON.stringify({
                'type': 'stop_typing'
            }));
            isTyping = false;
        }
    });
</script>
{% endblock %}